<!doctype html><html lang=ja><head><meta charset=utf-8><title>コミットしわすれている git リポジトリを通知する | よもぎさんのへや</title><meta name=viewport content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1"><link rel=stylesheet href=http://yomogitaro.github.io/article/css/sanitize.css><link rel=stylesheet href=http://yomogitaro.github.io/article/css/responsive.css><link rel=stylesheet href=/css/highlight_monokai.css><link rel=stylesheet/less href=http://yomogitaro.github.io/article/css/theme.less><link rel=stylesheet href=http://yomogitaro.github.io/article/css/custom.css><script src=http://yomogitaro.github.io/article/js/less.js type=text/javascript></script></head><body><div class=container><header role=banner><div class="row gutters"><div id=site-title class="col span_6"><h1><a href=http://yomogitaro.github.io/article/>よもぎさんのへや</a></h1><h2>たなからくさだいふく</h2></div><div id=social class="col span_6"><ul><li><a href=https://twitter.com/YOMOGItanpop target=_blank>Twitter</a></li><li><a href=https://github.com/yomogitaro target=_blank>GitHub</a></li></ul></div></div></header><main id=single role=main><div class=article-header><h1>コミットしわすれている git リポジトリを通知する</h1><div class=meta>May 15, 2016 &nbsp;</div></div><article><h1 id=コミットしわすれている-git-リポジトリをきれいにした>コミットしわすれている git リポジトリをきれいにした</h1><p>そもそもどんなリポジトリを作っていたかも謎になっていたので、探すところからやった。
cron で実行して通知するために、<code>DBUS_SESSION_BUS_ADDRESS</code>を探すところが苦労した。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env zsh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>SESSION_MANAGER<span style=color:#f92672>=</span>xfce4-session
</span></span><span style=display:flex><span>SCRIPT_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;yomogi-git-commit-reminder&#34;</span>
</span></span><span style=display:flex><span>NOTIFY_LIFE_TIME<span style=color:#f92672>=</span><span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> LIST_GIT_DIRS<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    find $HOME -xdev -type d -name .git 2&gt;/dev/null
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> create_remind_reports<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    LINE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    LIST_GIT_DIRS | <span style=color:#66d9ef>while</span> read git_dir
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        CHANGED_LINES<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>git --git-dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$git_dir<span style=color:#e6db74>&#34;</span> --work-tree<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$git_dir<span style=color:#e6db74>/..&#34;</span> status --porcelain | wc -l<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $CHANGED_LINES -gt <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            LINE<span style=color:#f92672>=</span>$LINE<span style=color:#e6db74>&#34; `printf &#34;</span>%05d<span style=color:#e6db74>&#34; </span>$CHANGED_LINES<span style=color:#e6db74>` </span><span style=color:#e6db74>${</span>git_dir%/*<span style=color:#e6db74>}</span><span style=color:#e6db74> \n&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    echo $LINE;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> output_report<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$VERBOSE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TRUE&#34;</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo $REPORTS
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$NOTIFY<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TRUE&#34;</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        PID<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pgrep xfce4-session<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        dbus<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep -z DBUS_SESSION_BUS_ADDRESS /proc/$PID/environ|cut -d<span style=color:#f92672>=</span> -f2-<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        export DBUS_SESSION_BUS_ADDRESS<span style=color:#f92672>=</span>$dbus
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        /usr/bin/notify-send --urgency<span style=color:#f92672>=</span>low --expire-time<span style=color:#f92672>=</span>$NOTIFY_LIFE_TIME --category<span style=color:#f92672>=</span>git <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                    --icon<span style=color:#f92672>=</span>$HOME/var/image/Git-Icon-White.png <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                    <span style=color:#e6db74>&#39;not commited git repos&#39;</span> $REPORTS
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>###</span>
</span></span><span style=display:flex><span><span style=color:#75715e># main section</span>
</span></span><span style=display:flex><span>VERBOSE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;TRUE&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> getopts nq OPT
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> $OPT in
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;n&#34;</span> <span style=color:#f92672>)</span> NOTIFY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;TRUE&#34;</span> ;;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;q&#34;</span> <span style=color:#f92672>)</span> VERBOSE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;FALSE&#34;</span> ;;
</span></span><span style=display:flex><span>          * <span style=color:#f92672>)</span> echo <span style=color:#e6db74>&#34;unexpected arg </span>$OPT<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>               exit 1;;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REPORTS<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>create_remind_reports<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>output_report <span style=color:#e6db74>&#34;</span>$REPORTS<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>こんな感じで出てくる。</p><pre tabindex=0><code>yomogi-git-commit-reminder.sh -n
 00003 /hoge/fuga
 00013 /piyo
</code></pre><p><code>-n</code> をつけると通知が出るようにして crontab に追加した。</p><h1 id=emacs-で-python-を書く設定をする>emacs で python を書く設定をする</h1><p><a href=https://www.emacswiki.org/emacs/PythonProgrammingInEmacs>https://www.emacswiki.org/emacs/PythonProgrammingInEmacs</a> を参考に書く。</p></article><script type=text/javascript>var disqus_shortname="";(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></main><footer role=contentinfo><div style=text-align:center><img src="https://s.gravatar.com/avatar/4d1410a9d92bd52625d4de8a51c389b7?s=80" width=64 height=64><br>Written by YOMOGITARO</div></footer></div><script src=http://yomogitaro.github.io/article/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>