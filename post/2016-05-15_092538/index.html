
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    コミットしわすれている git リポジトリを通知する | よもぎさんのへや
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">


  
  <link rel="stylesheet" href="http://yomogitaro.github.io/article/css/sanitize.css">
  <link rel="stylesheet" href="http://yomogitaro.github.io/article/css/responsive.css">
  <link rel="stylesheet" HREF="/css/highlight_monokai.css">
  <link rel="stylesheet/less" href="http://yomogitaro.github.io/article/css/theme.less">
  <link rel="stylesheet" href="http://yomogitaro.github.io/article/css/custom.css">


  
  <script src="http://yomogitaro.github.io/article/js/less.js" type="text/javascript"></script>


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://yomogitaro.github.io/article/">よもぎさんのへや</a></h1>
        <h2>たなからくさだいふく</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/YOMOGItanpop" target="_blank">Twitter</a></li>
          
          <li><a href="https://github.com/yomogitaro" target="_blank">GitHub</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>コミットしわすれている git リポジトリを通知する</h1>
      <div class="meta">
        May 15, 2016 &nbsp;
        
      </div>
    </div>
    <article>
      

<h1 id="コミットしわすれている-git-リポジトリをきれいにした">コミットしわすれている git リポジトリをきれいにした</h1>

<p>そもそもどんなリポジトリを作っていたかも謎になっていたので、探すところからやった。
cron で実行して通知するために、<code>DBUS_SESSION_BUS_ADDRESS</code>を探すところが苦労した。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">#!/usr/bin/env zsh</span>

<span style="color: #f8f8f2">SESSION_MANAGER</span><span style="color: #f92672">=</span>xfce4-session
<span style="color: #f8f8f2">SCRIPT_NAME</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;yomogi-git-commit-reminder&quot;</span>
<span style="color: #f8f8f2">NOTIFY_LIFE_TIME</span><span style="color: #f92672">=</span><span style="color: #ae81ff">5000</span>

<span style="color: #66d9ef">function</span> LIST_GIT_DIRS<span style="color: #f92672">()</span> <span style="color: #f92672">{</span>
    find <span style="color: #f8f8f2">$HOME</span> -xdev -type d -name .git <span style="color: #ae81ff">2</span>&gt;/dev/null
<span style="color: #f92672">}</span>


<span style="color: #66d9ef">function</span> create_remind_reports<span style="color: #f92672">()</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">LINE</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;&#39;</span>
    LIST_GIT_DIRS <span style="color: #f8f8f2">|</span> <span style="color: #66d9ef">while</span> <span style="color: #f8f8f2">read</span> git_dir
    <span style="color: #66d9ef">do</span>
        <span style="color: #f8f8f2">CHANGED_LINES</span><span style="color: #f92672">=</span><span style="color: #e6db74">`</span>git --git-dir<span style="color: #f92672">=</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">$git_dir</span><span style="color: #e6db74">&quot;</span> --work-tree<span style="color: #f92672">=</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">$git_dir</span><span style="color: #e6db74">/..&quot;</span> status --porcelain <span style="color: #f8f8f2">|</span> wc -l<span style="color: #e6db74">`</span>

        <span style="color: #66d9ef">if</span> <span style="color: #f92672">[</span> <span style="color: #f8f8f2">$CHANGED_LINES</span> -gt <span style="color: #ae81ff">0</span> <span style="color: #f92672">]</span>
        <span style="color: #66d9ef">then</span>
            <span style="color: #f8f8f2">LINE</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">$LINE</span><span style="color: #e6db74">&quot; `printf &quot;</span>%05d<span style="color: #e6db74">&quot; </span><span style="color: #f8f8f2">$CHANGED_LINES</span><span style="color: #e6db74">` ${</span><span style="color: #f8f8f2">git_dir%/*</span><span style="color: #e6db74">} \n&quot;</span>
        <span style="color: #66d9ef">fi</span>
    <span style="color: #66d9ef">done</span>

    <span style="color: #f8f8f2">echo</span> <span style="color: #f8f8f2">$LINE;</span>
<span style="color: #f92672">}</span>


<span style="color: #66d9ef">function</span> output_report<span style="color: #f92672">()</span> <span style="color: #f92672">{</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f92672">[</span> <span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">$VERBOSE</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;TRUE&quot;</span> <span style="color: #f92672">]</span>
    <span style="color: #66d9ef">then</span>
        <span style="color: #f8f8f2">echo</span> <span style="color: #f8f8f2">$REPORTS</span>
    <span style="color: #66d9ef">fi</span>

    <span style="color: #66d9ef">if</span> <span style="color: #f92672">[</span> <span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">$NOTIFY</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;TRUE&quot;</span> <span style="color: #f92672">]</span>
    <span style="color: #66d9ef">then</span>
        <span style="color: #f8f8f2">PID</span><span style="color: #f92672">=</span><span style="color: #66d9ef">$(</span>pgrep xfce4-session<span style="color: #66d9ef">)</span>
        <span style="color: #f8f8f2">dbus</span><span style="color: #f92672">=</span><span style="color: #66d9ef">$(</span>grep -z DBUS_SESSION_BUS_ADDRESS /proc/<span style="color: #f8f8f2">$PID</span>/environ<span style="color: #f8f8f2">|</span>cut -d<span style="color: #f92672">=</span> -f2-<span style="color: #66d9ef">)</span>
        <span style="color: #f8f8f2">export</span> <span style="color: #f8f8f2">DBUS_SESSION_BUS_ADDRESS</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">$dbus</span>

        /usr/bin/notify-send --urgency<span style="color: #f92672">=</span>low --expire-time<span style="color: #f92672">=</span><span style="color: #f8f8f2">$NOTIFY_LIFE_TIME</span> --category<span style="color: #f92672">=</span>git <span style="color: #ae81ff">\</span>
                    --icon<span style="color: #f92672">=</span><span style="color: #f8f8f2">$HOME</span>/var/image/Git-Icon-White.png <span style="color: #ae81ff">\</span>
                    <span style="color: #e6db74">&#39;not commited git repos&#39;</span> <span style="color: #f8f8f2">$REPORTS</span>
    <span style="color: #66d9ef">fi</span><span style="color: #f8f8f2">;</span>
<span style="color: #f92672">}</span>


<span style="color: #75715e">###</span>
<span style="color: #75715e"># main section</span>
<span style="color: #f8f8f2">VERBOSE</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;TRUE&quot;</span>
<span style="color: #66d9ef">while</span> <span style="color: #f8f8f2">getopts</span> nq OPT
<span style="color: #66d9ef">do</span>
    <span style="color: #66d9ef">case</span> <span style="color: #f8f8f2">$OPT</span> in
        <span style="color: #e6db74">&quot;n&quot;</span> <span style="color: #f92672">)</span> <span style="color: #f8f8f2">NOTIFY</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;TRUE&quot;</span> <span style="color: #f8f8f2">;;</span>
        <span style="color: #e6db74">&quot;q&quot;</span> <span style="color: #f92672">)</span> <span style="color: #f8f8f2">VERBOSE</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;FALSE&quot;</span> <span style="color: #f8f8f2">;;</span>
          * <span style="color: #f92672">)</span> <span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&quot;unexpected arg </span><span style="color: #f8f8f2">$OPT</span><span style="color: #e6db74">&quot;</span>
               <span style="color: #f8f8f2">exit</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;;</span>
    <span style="color: #66d9ef">esac</span>
<span style="color: #66d9ef">done</span>

<span style="color: #f8f8f2">REPORTS</span><span style="color: #f92672">=</span><span style="color: #e6db74">`</span>create_remind_reports<span style="color: #e6db74">`</span>
output_report <span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">$REPORTS</span><span style="color: #e6db74">&quot;</span>
</pre></div>

<p>こんな感じで出てくる。</p>

<pre><code>yomogi-git-commit-reminder.sh -n
 00003 /hoge/fuga
 00013 /piyo
</code></pre>

<p><code>-n</code> をつけると通知が出るようにして crontab に追加した。</p>

<h1 id="emacs-で-python-を書く設定をする">emacs で python を書く設定をする</h1>

<p><a href="https://www.emacswiki.org/emacs/PythonProgrammingInEmacs">https://www.emacswiki.org/emacs/PythonProgrammingInEmacs</a> を参考に書く。</p>

    </article>
    


<script type="text/javascript">
     
    var disqus_shortname = '';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </main>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="https://s.gravatar.com/avatar/4d1410a9d92bd52625d4de8a51c389b7?s=80" width="64" height="64"><br>
      Written by YOMOGITARO
    </div>
  </footer>


</div>

<script src="http://yomogitaro.github.io/article/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

