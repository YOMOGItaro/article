
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    evm と Emacs 25.1 とモジュール | よもぎさんのへや
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">


  
  <link rel="stylesheet" href="http://yomogitaro.github.io/article/css/sanitize.css">
  <link rel="stylesheet" href="http://yomogitaro.github.io/article/css/responsive.css">
  <link rel="stylesheet" HREF="/css/highlight_monokai.css">
  <link rel="stylesheet/less" href="http://yomogitaro.github.io/article/css/theme.less">
  <link rel="stylesheet" href="http://yomogitaro.github.io/article/css/custom.css">


  
  <script src="http://yomogitaro.github.io/article/js/less.js" type="text/javascript"></script>


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://yomogitaro.github.io/article/">よもぎさんのへや</a></h1>
        <h2>たなからくさだいふく</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/YOMOGItanpop" target="_blank">Twitter</a></li>
          
          <li><a href="https://github.com/yomogitaro" target="_blank">GitHub</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>evm と Emacs 25.1 とモジュール</h1>
      <div class="meta">
        Oct 9, 2016 &nbsp;
        
      </div>
    </div>
    <article>
      

<p>Emacs 25.1 から elisp 以外の言語で書かれたモジュールを読み込めるようになったらしい。</p>

<pre><code>Emacs can now load shared/dynamic libraries (modules). A dynamic Emacs module is a shared library that provides additional functionality for use in Emacs Lisp programs, just like a package written in Emacs Lisp would.
</code></pre>

<p>試してみる、ついでに evm を試したりする。</p>

<p><code>--with-module</code> がないとモジュールが動かないところではまったりした。</p>

<h1 id="evm-で-emacs-25-1-を試す">evm で Emacs 25.1 を試す</h1>

<p>ひとつの環境に複数のバージョンの Emacs を管理できる evm というツールがあるらしい。
いきなり 25.1 にするのは怖いので evm を入れてみる。</p>

<p><a href="https://github.com/rejeep/evm">https://github.com/rejeep/evm</a></p>

<p>readme の通り入れてみた。</p>

<pre><code class="language-sh">$ curl -fsSkL https://raw.github.com/rejeep/evm/master/go | bash
$ export PATH=&quot;$HOME/.evm/bin:$PATH&quot;
</code></pre>

<p>バージョンがあるか確認する。</p>

<pre><code class="language-sh">% evm list | grep 25.1
emacs-25.1
emacs-25.1-travis
</code></pre>

<p>あった。</p>

<p>evm はデフォルトで <code>/usr/local/evm</code> にファイルを作るようだったので設定を変更。</p>

<pre><code class="language-sh">% evm config path ~/evm
% mkdir evm
% evm install emacs-25.1
</code></pre>

<p>configure で失敗するらしい。</p>

<pre><code class="language-plain">checking for libXaw... configure: error: No X toolkit could be found.
If you are sure you want Emacs compiled without an X toolkit, pass
  --with-x-toolkit=no
to configure.  Otherwise, install the development libraries for the toolkit
that you want to use (e.g. Gtk+) and re-run configure.
Failed! See logs above for error.
</code></pre>

<p>この先いろんなライブラリが不足していると言われそうなのでとりあえず、 依存パッケージを落としておく。
これがいいわけではないとおもう。</p>

<pre><code class="language-sh">$ sudo apt-get build-dep emacs24
</code></pre>

<p>うまくコンパイルできた。
バイナリで着ている。</p>

<pre><code class="language-sh">$ evm bin emacs-25.1
/home/yourhome/evm/emacs-25.1/bin/emacs
</code></pre>

<pre><code class="language-sh">$ evm use emacs-25.1
</code></pre>

<p>Emacs が 25.1 で起動できるようになった。</p>

<h1 id="module-を動作させるところまで">module を動作させるところまで</h1>

<p>ここを参考にしてモジュールを作ってみる。
<a href="http://diobla.info/blog-archive/modules-tut.html">http://diobla.info/blog-archive/modules-tut.html</a></p>

<p><code>emacs-module.h</code> を使うらしい。さっき evm に入って中に含まれるのでこれをつかう。</p>

<pre><code class="language-sh">$ cp /home/yourhome/evm/tmp/emacs-25.1/src/emacs-module.h ~/include/
</code></pre>

<p>サンプルの <code>mymod.c</code> をコンパイルして <code>mymod.so</code> を作って、 <code>(require 'mymod)</code> したが下記のエラーがでて読み込まれなかった。</p>

<pre><code class="language-plain">Debugger entered--Lisp error: (file-error &quot;Cannot open load file&quot; &quot;そのようなファイルやディレクトリはありません&quot; &quot;mymod&quot;)
</code></pre>

<p><code>.el</code>, <code>.elc</code> しか読まれないようになっていそうだった。
よく見たら Emacs のコンパイルで <code>configure</code> の時に <code>--with-modules</code> が必要そうだ。</p>

<pre><code class="language-plain">--with-modules          compile with dynamic modules support
</code></pre>

<p>evm でオプションを有効にしたレシピを作ってみた。</p>

<pre><code class="language-diff">% diff -u ~/.evm/recipes/{emacs-25.1,emacs-25.1-with-modules}.rb
--- /home/yomogi/.evm/recipes/emacs-25.1.rb     2016-10-09 15:14:06.824971490 +0900
+++ /home/yomogi/.evm/recipes/emacs-25.1-with-modules.rb        2016-10-10 10:46:54.497478153 +0900
@@ -1,4 +1,4 @@
-recipe 'emacs-25.1' do
+recipe 'emacs-25.1-with-modules' do
   tar_xz 'http://ftpmirror.gnu.org/emacs/emacs-25.1.tar.gz'

   osx do
@@ -12,6 +12,8 @@
     option '--without-gif'
   end

+  option '--with-modules'
+
   install do
     configure
     make 'install'
</code></pre>

<p>ちゃんとたされたか確認してコンパイルして、設定。</p>

<pre><code class="language-sh">% evm list | grep emacs-25.1-with-modules
emacs-25.1-with-modules
% evm install emacs-25.1-with-modules
% evm use emacs-25.1-with-modules
</code></pre>

<p>起動して動作確認</p>

<pre><code>% emacs -Q -L path/to/module
</code></pre>

<pre><code>(require 'mymod)
mymod
(mymod-test)
42
</code></pre>

<p>うまく行った。</p>

<h1 id="モジュールを作ってみる">モジュールを作ってみる</h1>

<p>サンプルは、固定値を表示するだけの関数だったので、引数を取るような  plusone を作ってみる。モジュール名は tekito にする。
どのような関数が用意されているかは <a href="https://github.com/emacs-mirror/emacs/blob/emacs-25/src/emacs-module.h">emacs-module.h</a>, <a href="https://github.com/emacs-mirror/emacs/blob/emacs-25/src/emacs-module.c">emacs-module.c</a> をみながら考えた。</p>

<pre><code class="language-c">#include &lt;emacs-module.h&gt;

int plugin_is_GPL_compatible;


const int PLUSONE_MAX_ARGS_NUM = 1;
const int PLUSONE_MIN_ARGS_NUM = 1;
const char * const PLUSONE_DOC_STRING = &quot;doc&quot;;

static
emacs_value
plusone
(
 emacs_env * env,
 const int nargs,
 const emacs_value const args[],
 void * data
 )
{
  int val;

  val = env-&gt;extract_integer(env, args[0]);

  return env-&gt;make_integer (env, val + 1);
}

// fset を呼び出して、 name で Sfun が呼ばれるようにする関数
// (fset '{{name}} Sfun) をする
static void
fset
(
 emacs_env * env,
 const char * const name,
 const emacs_value func_obj
 )
{
  static const int FSET_ARGS_NUM = 2;
  emacs_value func_name = env-&gt;intern (env, &quot;fset&quot;);
  emacs_value func_args[] = { env-&gt;intern (env, name), func_obj };

  env-&gt;funcall(
                env,
                func_name,
                FSET_ARGS_NUM,
                func_args
               );
}

// provide を呼び出す関数
// (provide '{{feature}}) をする
static void
provide
(
 emacs_env *env,
 const char * const feature
 )
{
  static const int PROVIDE_ARGS_NUM = 1;
  emacs_value func_name = env-&gt;intern (env, &quot;provide&quot;);
  emacs_value func_args[] = { env-&gt;intern (env, feature) };

  env-&gt;funcall (
                env,
                func_name,
                PROVIDE_ARGS_NUM,
                func_args
                );
}

int
emacs_module_init
(
 struct emacs_runtime *ert
 )
{
  emacs_env * env = ert-&gt;get_environment (ert);
  emacs_value fun =
    env-&gt;make_function(
                       env,
                       PLUSONE_MIN_ARGS_NUM,
                       PLUSONE_MAX_ARGS_NUM,
                       (emacs_value (*)())plusone,
                       PLUSONE_DOC_STRING,
                       NULL // よくわかっていない
  );

  fset(env, &quot;plusone&quot;, fun);
  provide (env, &quot;tekito&quot;);

  return 0;
}
</code></pre>

<p>Makefile はこんな感じ</p>

<pre><code class="language-makefile">LIBRARY    = $(HOME)/include
CC      = gcc
LD      = gcc
CFLAGS  = -ggdb3 -Wall
LDFLAGS =

all: tekito.so

%.so: %.o
	$(LD) -shared $(LDFLAGS) -o $@ $&lt;

%.o: %.c
	$(CC) $(CFLAGS) -I$(LIBRARY) -fPIC -c $&lt;
</code></pre>

<p>Emacs で動作を試してみた。うまく動いた。</p>

<pre><code>emacs -Q -L &quot;${HOME}/Programs/sandbox/20161010/&quot;
</code></pre>

<p>scratch バッファでいろいろ。</p>

<pre><code class="language-md">(require 'tekito)
tekito
(plusone 15)
16
(require 'tekito)
tekito
(plusone 5)
6
(plusone -2000)
-1999
</code></pre>

<h1 id="まとめ">まとめ</h1>

<ul>
<li>Emacs 25.1 でモジュールを使うときには、 Emacs をビルドするときに <code>--with-modules</code> のオプションがいる。</li>
<li>C と C++ 以外で使えるのかはよくわからなかった。</li>
</ul>

<h1 id="その他">その他</h1>

<ul>
<li>英語を読むとき昔使っていた firefox のがうまく動かないので、結局 chrome の weblio プラグインにした。</li>
</ul>

    </article>
    


<script type="text/javascript">
     
    var disqus_shortname = '';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </main>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="https://s.gravatar.com/avatar/4d1410a9d92bd52625d4de8a51c389b7?s=80" width="64" height="64"><br>
      Written by YOMOGITARO
    </div>
  </footer>


</div>

<script src="http://yomogitaro.github.io/article/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

