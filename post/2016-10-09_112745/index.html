
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    evm と Emacs 25.1 とモジュール | よもぎさんのへや
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">


  
  <link rel="stylesheet" href="http://yomogitaro.github.io/article/css/sanitize.css">
  <link rel="stylesheet" href="http://yomogitaro.github.io/article/css/responsive.css">
  <link rel="stylesheet" HREF="/css/highlight_monokai.css">
  <link rel="stylesheet/less" href="http://yomogitaro.github.io/article/css/theme.less">
  <link rel="stylesheet" href="http://yomogitaro.github.io/article/css/custom.css">


  
  <script src="http://yomogitaro.github.io/article/js/less.js" type="text/javascript"></script>


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://yomogitaro.github.io/article/">よもぎさんのへや</a></h1>
        <h2>たなからくさだいふく</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/YOMOGItanpop" target="_blank">Twitter</a></li>
          
          <li><a href="https://github.com/yomogitaro" target="_blank">GitHub</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>evm と Emacs 25.1 とモジュール</h1>
      <div class="meta">
        Oct 9, 2016 &nbsp;
        
      </div>
    </div>
    <article>
      

<p>Emacs 25.1 から elisp 以外の言語で書かれたモジュールを読み込めるようになったらしい。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>Emacs can now load shared/dynamic libraries (modules). A dynamic Emacs module is a shared library that provides additional functionality for use in Emacs Lisp programs, just like a package written in Emacs Lisp would.
</pre></div>

<p>試してみる、ついでに evm を試したりする。</p>

<p><code>--with-module</code> がないとモジュールが動かないところではまったりした。</p>

<h1 id="evm-で-emacs-25-1-を試す">evm で Emacs 25.1 を試す</h1>

<p>ひとつの環境に複数のバージョンの Emacs を管理できる evm というツールがあるらしい。
いきなり 25.1 にするのは怖いので evm を入れてみる。</p>

<p><a href="https://github.com/rejeep/evm">https://github.com/rejeep/evm</a></p>

<p>readme の通り入れてみた。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ curl -fsSkL https://raw.github.com/rejeep/evm/master/go <span style="color: #f8f8f2">|</span> bash
$ <span style="color: #f8f8f2">export</span> <span style="color: #f8f8f2">PATH</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">$HOME</span><span style="color: #e6db74">/.evm/bin:</span><span style="color: #f8f8f2">$PATH</span><span style="color: #e6db74">&quot;</span>
</pre></div>

<p>バージョンがあるか確認する。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>% evm list <span style="color: #f8f8f2">|</span> grep <span style="color: #ae81ff">25</span>.1
emacs-25.1
emacs-25.1-travis
</pre></div>

<p>あった。</p>

<p>evm はデフォルトで <code>/usr/local/evm</code> にファイルを作るようだったので設定を変更。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>% evm config path ~/evm
% mkdir evm
% evm install emacs-25.1
</pre></div>

<p>configure で失敗するらしい。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>checking for libXaw... configure: error: No X toolkit could be found.
If you are sure you want Emacs compiled without an X toolkit, pass
  --with-x-toolkit=no
to configure.  Otherwise, install the development libraries for the toolkit
that you want to use (e.g. Gtk+) and re-run configure.
Failed! See logs above for error.
</pre></div>

<p>この先いろんなライブラリが不足していると言われそうなのでとりあえず、 依存パッケージを落としておく。
これがいいわけではないとおもう。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ sudo apt-get build-dep emacs24
</pre></div>

<p>うまくコンパイルできた。
バイナリで着ている。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ evm bin emacs-25.1
/home/yourhome/evm/emacs-25.1/bin/emacs
</pre></div>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ evm use emacs-25.1
</pre></div>

<p>Emacs が 25.1 で起動できるようになった。</p>

<h1 id="module-を動作させるところまで">module を動作させるところまで</h1>

<p>ここを参考にしてモジュールを作ってみる。
<a href="http://diobla.info/blog-archive/modules-tut.html">http://diobla.info/blog-archive/modules-tut.html</a></p>

<p><code>emacs-module.h</code> を使うらしい。さっき evm に入って中に含まれるのでこれをつかう。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ cp /home/yourhome/evm/tmp/emacs-25.1/src/emacs-module.h ~/include/
</pre></div>

<p>サンプルの <code>mymod.c</code> をコンパイルして <code>mymod.so</code> を作って、 <code>(require 'mymod)</code> したが下記のエラーがでて読み込まれなかった。</p>

<pre><code>Debugger entered--Lisp error: (file-error &quot;Cannot open load file&quot; &quot;そのようなファイルやディレクトリはありません&quot; &quot;mymod&quot;)
</code></pre>

<p><code>.el</code>, <code>.elc</code> しか読まれないようになっていそうだった。
よく見たら Emacs のコンパイルで <code>configure</code> の時に <code>--with-modules</code> が必要そうだ。</p>

<pre><code>--with-modules          compile with dynamic modules support
</code></pre>

<p>evm でオプションを有効にしたレシピを作ってみた。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>% diff -u ~/.evm/recipes/{emacs-25.1,emacs-25.1-with-modules}.rb
<span style="color: #f92672">--- /home/yomogi/.evm/recipes/emacs-25.1.rb     2016-10-09 15:14:06.824971490 +0900</span>
<span style="color: #a6e22e">+++ /home/yomogi/.evm/recipes/emacs-25.1-with-modules.rb        2016-10-10 10:46:54.497478153 +0900</span>
<span style="color: #75715e">@@ -1,4 +1,4 @@</span>
<span style="color: #f92672">-recipe &#39;emacs-25.1&#39; do</span>
<span style="color: #a6e22e">+recipe &#39;emacs-25.1-with-modules&#39; do</span>
   tar_xz &#39;http://ftpmirror.gnu.org/emacs/emacs-25.1.tar.gz&#39;

   osx do
<span style="color: #75715e">@@ -12,6 +12,8 @@</span>
     option &#39;--without-gif&#39;
   end

<span style="color: #a6e22e">+  option &#39;--with-modules&#39;</span>
<span style="color: #a6e22e">+</span>
   install do
     configure
     make &#39;install&#39;
</pre></div>

<p>ちゃんとたされたか確認してコンパイルして、設定。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>% evm list <span style="color: #f8f8f2">|</span> grep emacs-25.1-with-modules
emacs-25.1-with-modules
% evm install emacs-25.1-with-modules
% evm use emacs-25.1-with-modules
</pre></div>

<p>起動して動作確認</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>% emacs -Q -L path/to/module
</pre></div>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">(require</span> <span style="color: #e6db74">&#39;mymod</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">mymod</span>
<span style="color: #f8f8f2">(mymod-test)</span>
<span style="color: #ae81ff">42</span>
</pre></div>

<p>うまく行った。</p>

<h1 id="モジュールを作ってみる">モジュールを作ってみる</h1>

<p>サンプルは、固定値を表示するだけの関数だったので、引数を取るような  plusone を作ってみる。モジュール名は tekito にする。
どのような関数が用意されているかは <a href="https://github.com/emacs-mirror/emacs/blob/emacs-25/src/emacs-module.h">emacs-module.h</a>, <a href="https://github.com/emacs-mirror/emacs/blob/emacs-25/src/emacs-module.c">emacs-module.c</a> をみながら考えた。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;emacs-module.h&gt;</span>

<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">plugin_is_GPL_compatible;</span>


<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">PLUSONE_MAX_ARGS_NUM</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">PLUSONE_MIN_ARGS_NUM</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">PLUSONE_DOC_STRING</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;doc&quot;</span><span style="color: #f8f8f2">;</span>

<span style="color: #66d9ef">static</span>
<span style="color: #f8f8f2">emacs_value</span>
<span style="color: #a6e22e">plusone</span>
<span style="color: #f8f8f2">(</span>
 <span style="color: #f8f8f2">emacs_env</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">env,</span>
 <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nargs,</span>
 <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">emacs_value</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">args[],</span>
 <span style="color: #66d9ef">void</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">data</span>
 <span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">val;</span>

  <span style="color: #f8f8f2">val</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">env</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">extract_integer(env,</span> <span style="color: #f8f8f2">args[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]);</span>

  <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">env</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">make_integer</span> <span style="color: #f8f8f2">(env,</span> <span style="color: #f8f8f2">val</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #75715e">// fset を呼び出して、 name で Sfun が呼ばれるようにする関数</span>
<span style="color: #75715e">// (fset &#39;{{name}} Sfun) をする</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span>
<span style="color: #a6e22e">fset</span>
<span style="color: #f8f8f2">(</span>
 <span style="color: #f8f8f2">emacs_env</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">env,</span>
 <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">name,</span>
 <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">emacs_value</span> <span style="color: #f8f8f2">func_obj</span>
 <span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">FSET_ARGS_NUM</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
  <span style="color: #f8f8f2">emacs_value</span> <span style="color: #f8f8f2">func_name</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">env</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">intern</span> <span style="color: #f8f8f2">(env,</span> <span style="color: #e6db74">&quot;fset&quot;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">emacs_value</span> <span style="color: #f8f8f2">func_args[]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{</span> <span style="color: #f8f8f2">env</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">intern</span> <span style="color: #f8f8f2">(env,</span> <span style="color: #f8f8f2">name),</span> <span style="color: #f8f8f2">func_obj</span> <span style="color: #f8f8f2">};</span>

  <span style="color: #f8f8f2">env</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">funcall(</span>
                <span style="color: #f8f8f2">env,</span>
                <span style="color: #f8f8f2">func_name,</span>
                <span style="color: #f8f8f2">FSET_ARGS_NUM,</span>
                <span style="color: #f8f8f2">func_args</span>
               <span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #75715e">// provide を呼び出す関数</span>
<span style="color: #75715e">// (provide &#39;{{feature}}) をする</span>
<span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span>
<span style="color: #a6e22e">provide</span>
<span style="color: #f8f8f2">(</span>
 <span style="color: #f8f8f2">emacs_env</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">env,</span>
 <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">feature</span>
 <span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">static</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">PROVIDE_ARGS_NUM</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
  <span style="color: #f8f8f2">emacs_value</span> <span style="color: #f8f8f2">func_name</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">env</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">intern</span> <span style="color: #f8f8f2">(env,</span> <span style="color: #e6db74">&quot;provide&quot;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">emacs_value</span> <span style="color: #f8f8f2">func_args[]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{</span> <span style="color: #f8f8f2">env</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">intern</span> <span style="color: #f8f8f2">(env,</span> <span style="color: #f8f8f2">feature)</span> <span style="color: #f8f8f2">};</span>

  <span style="color: #f8f8f2">env</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">funcall</span> <span style="color: #f8f8f2">(</span>
                <span style="color: #f8f8f2">env,</span>
                <span style="color: #f8f8f2">func_name,</span>
                <span style="color: #f8f8f2">PROVIDE_ARGS_NUM,</span>
                <span style="color: #f8f8f2">func_args</span>
                <span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">int</span>
<span style="color: #a6e22e">emacs_module_init</span>
<span style="color: #f8f8f2">(</span>
 <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">emacs_runtime</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">ert</span>
 <span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #f8f8f2">emacs_env</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">env</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">ert</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">get_environment</span> <span style="color: #f8f8f2">(ert);</span>
  <span style="color: #f8f8f2">emacs_value</span> <span style="color: #f8f8f2">fun</span> <span style="color: #f92672">=</span>
    <span style="color: #f8f8f2">env</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">make_function(</span>
                       <span style="color: #f8f8f2">env,</span>
                       <span style="color: #f8f8f2">PLUSONE_MIN_ARGS_NUM,</span>
                       <span style="color: #f8f8f2">PLUSONE_MAX_ARGS_NUM,</span>
                       <span style="color: #f8f8f2">(emacs_value</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)())plusone,</span>
                       <span style="color: #f8f8f2">PLUSONE_DOC_STRING,</span>
                       <span style="color: #f8f8f2">NULL</span> <span style="color: #75715e">// よくわかっていない</span>
  <span style="color: #f8f8f2">);</span>

  <span style="color: #f8f8f2">fset(env,</span> <span style="color: #e6db74">&quot;plusone&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">fun);</span>
  <span style="color: #f8f8f2">provide</span> <span style="color: #f8f8f2">(env,</span> <span style="color: #e6db74">&quot;tekito&quot;</span><span style="color: #f8f8f2">);</span>

  <span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p>Makefile はこんな感じ</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">LIBRARY</span>    <span style="color: #f92672">=</span> <span style="color: #66d9ef">$(</span>HOME<span style="color: #66d9ef">)</span>/include
<span style="color: #f8f8f2">CC</span>      <span style="color: #f92672">=</span> gcc
<span style="color: #f8f8f2">LD</span>      <span style="color: #f92672">=</span> gcc
<span style="color: #f8f8f2">CFLAGS</span>  <span style="color: #f92672">=</span> -ggdb3 -Wall
<span style="color: #f8f8f2">LDFLAGS</span> <span style="color: #f92672">=</span>

<span style="color: #a6e22e">all</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">tekito</span>.<span style="color: #f8f8f2">so</span>

<span style="color: #a6e22e">%.so</span><span style="color: #f92672">:</span> %.<span style="color: #f8f8f2">o</span>
	<span style="color: #66d9ef">$(</span>LD<span style="color: #66d9ef">)</span> -shared <span style="color: #66d9ef">$(</span>LDFLAGS<span style="color: #66d9ef">)</span> -o <span style="color: #f8f8f2">$@</span> $&lt;

<span style="color: #a6e22e">%.o</span><span style="color: #f92672">:</span> %.<span style="color: #f8f8f2">c</span>
	<span style="color: #66d9ef">$(</span>CC<span style="color: #66d9ef">)</span> <span style="color: #66d9ef">$(</span>CFLAGS<span style="color: #66d9ef">)</span> -I<span style="color: #66d9ef">$(</span>LIBRARY<span style="color: #66d9ef">)</span> -fPIC -c $&lt;
</pre></div>

<p>Emacs で動作を試してみた。うまく動いた。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>emacs -Q -L <span style="color: #e6db74">&quot;${</span><span style="color: #f8f8f2">HOME</span><span style="color: #e6db74">}/Programs/sandbox/20161010/&quot;</span>
</pre></div>

<p>scratch バッファでいろいろ。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>(require &#39;tekito)
tekito
(plusone 15)
16
(require &#39;tekito)
tekito
(plusone 5)
6
(plusone -2000)
-1999
</pre></div>

<h1 id="まとめ">まとめ</h1>

<ul>
<li>Emacs 25.1 でモジュールを使うときには、 Emacs をビルドするときに <code>--with-modules</code> のオプションがいる。</li>
<li>C と C++ 以外で使えるのかはよくわからなかった。</li>
</ul>

<h1 id="その他">その他</h1>

<ul>
<li>英語を読むとき昔使っていた firefox のがうまく動かないので、結局 chrome の weblio プラグインにした。</li>
</ul>

    </article>
    


<script type="text/javascript">
     
    var disqus_shortname = '';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </main>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="https://s.gravatar.com/avatar/4d1410a9d92bd52625d4de8a51c389b7?s=80" width="64" height="64"><br>
      Written by YOMOGITARO
    </div>
  </footer>


</div>

<script src="http://yomogitaro.github.io/article/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

