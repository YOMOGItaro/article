<!doctype html><html lang=ja><head><meta charset=utf-8><title>embulk で csv を elasticsearch に移したい | よもぎさんのへや</title><meta name=viewport content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1"><link rel=stylesheet href=http://yomogitaro.github.io/article/css/sanitize.css><link rel=stylesheet href=http://yomogitaro.github.io/article/css/responsive.css><link rel=stylesheet href=/css/highlight_monokai.css><link rel=stylesheet/less href=http://yomogitaro.github.io/article/css/theme.less><link rel=stylesheet href=http://yomogitaro.github.io/article/css/custom.css><script src=http://yomogitaro.github.io/article/js/less.js type=text/javascript></script></head><body><div class=container><header role=banner><div class="row gutters"><div id=site-title class="col span_6"><h1><a href=http://yomogitaro.github.io/article/>よもぎさんのへや</a></h1><h2>たなからくさだいふく</h2></div><div id=social class="col span_6"><ul><li><a href=https://twitter.com/YOMOGItanpop target=_blank>Twitter</a></li><li><a href=https://github.com/yomogitaro target=_blank>GitHub</a></li></ul></div></div></header><main id=single role=main><div class=article-header><h1>embulk で csv を elasticsearch に移したい</h1><div class=meta>Jul 20, 2015 &nbsp;</div></div><article><h1 id=やりたいこと>やりたいこと</h1><ul><li>csv のファイルの内容を elasticsearch に移行したい</li></ul><h1 id=試した方法>試した方法</h1><p>embulk を利用すればできそうなので試してみた。</p><h2 id=テスト用-elasticsearch-の準備>テスト用 elasticsearch の準備　</h2><p>elasticsearch を入れる</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>% docker run -d --name es1 elasticsearch
</span></span></code></pre></div><p>IP を確認して動いているか確認</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>% docker inspect --format <span style=color:#e6db74>&#39;{{ .NetworkSettings.IPAddress }}&#39;</span> es1
</span></span><span style=display:flex><span>% curl <span style=color:#e6db74>&#39;http://172.17.0.4:9200/_stats&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;_shards&#34;</span>:<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;total&#34;</span>:0,<span style=color:#e6db74>&#34;successful&#34;</span>:0,<span style=color:#e6db74>&#34;failed&#34;</span>:0<span style=color:#f92672>}</span>,<span style=color:#e6db74>&#34;_all&#34;</span>:<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;primaries&#34;</span>:<span style=color:#f92672>{}</span>,<span style=color:#e6db74>&#34;total&#34;</span>:<span style=color:#f92672>{}}</span>,<span style=color:#e6db74>&#34;indices&#34;</span>:<span style=color:#f92672>{}}</span>%
</span></span></code></pre></div><p>ドキュメントを UI から確認するために kibana も用意</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>% docker run --link es1:elasticsearch -d --name kibana01 kibana
</span></span><span style=display:flex><span>% docker inspect --format <span style=color:#e6db74>&#39;{{ .NetworkSettings.IPAddress }}&#39;</span> kibana01
</span></span></code></pre></div><ul><li>http://172.17.0.6:5601 動いているか見てみる</li></ul><h2 id=embulk-のインストール>embulk のインストール</h2><p>java が必要なので入れる</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>% sudo apt-get install openjdk-8-jdk 
</span></span></code></pre></div><p><a href=https://github.com/embulk/embulk#linux--mac--bsd>ここ</a>に書いてあるとおりに入れてみる
サンプルを動かしてみる</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>% embulk example ./try1
</span></span><span style=display:flex><span>% embulk guess ./try1/example.yml -o config.yml
</span></span><span style=display:flex><span>% embulk preview config.yml
</span></span><span style=display:flex><span>% embulk run config.yml
</span></span></code></pre></div><h2 id=embulk-elasticsearch-プラグインのインストール>embulk elasticsearch プラグインのインストール</h2><p>elasticsearch の output-plugin をインストール</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>% embulk gem install embulk-output-elasticsearch
</span></span></code></pre></div><p>example を下記のように編集</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>in</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>file</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>path_prefix</span>: <span style=color:#e6db74>&#34;/tmp/try1/csv/sample_&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>out</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>elasticsearch</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>nodes</span>:
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>host: 172.17.0.4, port</span>: <span style=color:#ae81ff>9300</span>}
</span></span><span style=display:flex><span><span style=color:#f92672>index</span>: <span style=color:#ae81ff>embulk</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>index_type</span>: <span style=color:#ae81ff>embulk</span>
</span></span></code></pre></div><p>config 再生成して実行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>% embulk guess ./try1/example.yml -o config.yml
</span></span><span style=display:flex><span>% embulk run config.yml
</span></span></code></pre></div><p>うまくいっているか確認</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>curl <span style=color:#e6db74>&#39;http://172.17.0.4:9200/embulk/_search&#39;</span> | jq .
</span></span></code></pre></div></article><script type=text/javascript>var disqus_shortname="";(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></main><footer role=contentinfo><div style=text-align:center><img src="https://s.gravatar.com/avatar/4d1410a9d92bd52625d4de8a51c389b7?s=80" width=64 height=64><br>Written by YOMOGITARO</div></footer></div><script src=http://yomogitaro.github.io/article/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>