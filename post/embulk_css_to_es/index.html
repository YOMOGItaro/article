
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    embulk で csv を elasticsearch に移したい | よもぎさんのへや
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">


  
  <link rel="stylesheet" href="/article/css/sanitize.css">
  <link rel="stylesheet" href="/article/css/responsive.css">
  <link rel="stylesheet" HREF="/article/css/highlight_monokai.css">
  <link rel="stylesheet/less" href="/article/css/theme.less">
  <link rel="stylesheet" href="/article/css/custom.css">


  
  <script src="/article/js/less.js" type="text/javascript"></script>


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="/article/">よもぎさんのへや</a></h1>
        <h2>たなからくさだいふく</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/YOMOGItanpop" target="_blank">Twitter</a></li>
          
          <li><a href="https://github.com/yomogitaro" target="_blank">GitHub</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>embulk で csv を elasticsearch に移したい</h1>
      <div class="meta">
        Jul 20, 2015 &nbsp;
        
      </div>
    </div>
    <article>
      

<h1 id="やりたいこと">やりたいこと</h1>

<ul>
<li>csv のファイルの内容を elasticsearch に移行したい</li>
</ul>

<h1 id="試した方法">試した方法</h1>

<p>embulk を利用すればできそうなので試してみた。</p>

<h2 id="テスト用-elasticsearch-の準備">テスト用 elasticsearch の準備　</h2>

<p>elasticsearch を入れる</p>

<pre><code class="language-zsh">% docker run -d --name es1 elasticsearch
</code></pre>

<p>IP を確認して動いているか確認</p>

<pre><code class="language-zsh">% docker inspect --format '{{ .NetworkSettings.IPAddress }}' es1
% curl 'http://172.17.0.4:9200/_stats'
{&quot;_shards&quot;:{&quot;total&quot;:0,&quot;successful&quot;:0,&quot;failed&quot;:0},&quot;_all&quot;:{&quot;primaries&quot;:{},&quot;total&quot;:{}},&quot;indices&quot;:{}}%
</code></pre>

<p>ドキュメントを UI から確認するために kibana も用意</p>

<pre><code class="language-zsh">% docker run --link es1:elasticsearch -d --name kibana01 kibana
% docker inspect --format '{{ .NetworkSettings.IPAddress }}' kibana01
</code></pre>

<ul>
<li><a href="http://172.17.0.6:5601">http://172.17.0.6:5601</a> 動いているか見てみる</li>
</ul>

<h2 id="embulk-のインストール">embulk のインストール</h2>

<p>java が必要なので入れる</p>

<pre><code class="language-zsh">% sudo apt-get install openjdk-8-jdk 
</code></pre>

<p><a href="https://github.com/embulk/embulk#linux--mac--bsd">ここ</a>に書いてあるとおりに入れてみる
サンプルを動かしてみる</p>

<pre><code class="language-zsh">% embulk example ./try1
% embulk guess ./try1/example.yml -o config.yml
% embulk preview config.yml
% embulk run config.yml
</code></pre>

<h2 id="embulk-elasticsearch-プラグインのインストール">embulk elasticsearch プラグインのインストール</h2>

<p>elasticsearch の output-plugin をインストール</p>

<pre><code class="language-zsh">% embulk gem install embulk-output-elasticsearch
</code></pre>

<p>example を下記のように編集</p>

<pre><code class="language-yaml">in:
  type: file
  path_prefix: &quot;/tmp/try1/csv/sample_&quot;
out:
  type: elasticsearch
  nodes:
  - {host: 172.17.0.4, port: 9300}
index: embulk
  index_type: embulk
</code></pre>

<p>config 再生成して実行</p>

<pre><code class="language-zsh">% embulk guess ./try1/example.yml -o config.yml
% embulk run config.yml
</code></pre>

<p>うまくいっているか確認</p>

<pre><code class="language-zsh">curl 'http://172.17.0.4:9200/embulk/_search' | jq .
</code></pre>

    </article>
    


<script type="text/javascript">
     
    var disqus_shortname = '';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </main>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="https://s.gravatar.com/avatar/4d1410a9d92bd52625d4de8a51c389b7?s=80" width="64" height="64"><br>
      Written by YOMOGITARO
    </div>
  </footer>


</div>

<script src="/article/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

